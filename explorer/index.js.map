{"version":3,"sources":["node_modules/browser-pack/_prelude.js","src/index.js","src/renderer.js","src/ui.js"],"names":[],"mappings":"AAAA;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AClBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()","const AppRenderer = require(\"./renderer\");\nconst UI = require(\"./ui\");\n\nconst stats = new Stats();\n$(\"body\").append(stats.domElement);\n$(stats.domElement).hide();\nstats.toggle = () => $(stats.domElement).toggle();\n\nconst appRenderer = new AppRenderer(stats);\nconst ui = new UI(appRenderer);\n\nui.init();\n\n// Allow user to access appRenderer\n// This is not used by the app itself\nglobal.appRenderer = appRenderer;\nglobal.ui = ui;\nglobal.stats = stats;\n","const CANVAS_CLEAR_COLOR = 0x342920;\nconst FOG_LENGTH = 5000;\n\nclass AppRenderer {\n  constructor(stats) {\n    this.localReader = undefined;\n    this._threeContext = {};\n    this._mapMeshes = [];\n    this._mapContext = undefined;\n    this._renderOptions = undefined;\n    this.stats = stats;\n\n    // Defaults\n    this.fog = 25000;\n    this.movementSpeed = 10000;\n    this.lightIntensity = 0.5;\n    this.loadedMapID = undefined;\n    this.controllerType = \"fly\";\n\n    this.webGLRendererOptions = {\n      sortObjects: false,\n      logarithmicDepthBuffer: true,\n      stencil: false,\n      premultipliedAlpha: false,\n      antialiasing: true,\n    };\n  }\n\n  /** PUBLIC methods */\n  createLocalReader(file, callback) {\n    this.localReader = T3D.getLocalReader(file, callback, \"./static/t3dworker.js\");\n  }\n\n  getMapList() {\n    return this.localReader.getMapList();\n  }\n\n  scanArchiveForMaps() {\n    return this.localReader.readFileList();\n  }\n\n  loadMap(mapId, renderOptions, callback) {\n    if (this.loadedMapID) {\n      this.cleanupMap();\n    }\n\n    this.loadedMapID = mapId;\n    this._renderOptions = renderOptions;\n\n    const renderers = [\n      { renderClass: T3D.EnvironmentRenderer, settings: {} },\n      { renderClass: T3D.TerrainRenderer, settings: {} },\n    ];\n\n    if (renderOptions.zone) {\n      renderers.push({ renderClass: T3D.ZoneRenderer, settings: { visible: true } });\n    }\n    if (renderOptions.props) {\n      renderers.push({ renderClass: T3D.PropertiesRenderer, settings: { visible: true } });\n    }\n    if (renderOptions.collisions) {\n      renderers.push({ renderClass: T3D.HavokRenderer, settings: { visible: true } });\n    }\n\n    T3D.renderMapContentsAsync(this.localReader, this.loadedMapID, renderers, (context) => {\n      this._loadMapCallback(context, renderOptions, callback);\n    });\n  }\n\n  setFogDistance(value) {\n    this.fog = value;\n    if (this._threeContext.scene && this._threeContext.scene.fog) {\n      this._threeContext.scene.fog.near = this.fog;\n      this._threeContext.scene.fog.far = this.fog + FOG_LENGTH;\n    }\n    if (this._threeContext.camera) {\n      this._threeContext.camera.far = this.fog + FOG_LENGTH;\n      this._threeContext.camera.updateProjectionMatrix();\n    }\n  }\n\n  setMovementSpeed(value) {\n    this.movementSpeed = value;\n    if (this._threeContext.controls) {\n      this._threeContext.controls.movementSpeed = value;\n    }\n  }\n\n  move(x, y, z) {\n    if (x) {\n      this._threeContext.controls.object.position.x = x;\n    }\n    if (y) {\n      this._threeContext.controls.object.position.y = y;\n    }\n    if (z) {\n      this._threeContext.controls.object.position.z = z;\n    }\n  }\n\n  rotate(rx, ry, rz) {\n    if (rx) {\n      this._threeContext.controls.object.rotation.x = rx;\n    }\n    if (ry) {\n      this._threeContext.controls.object.rotation.y = ry;\n    }\n    if (rz) {\n      this._threeContext.controls.object.rotation.z = rz;\n    }\n  }\n\n  setLightIntensity(value) {\n    this.lightIntensity = value;\n    if (this._threeContext.sceneLights) {\n      for (const light of this._threeContext.sceneLights) {\n        light.intensity = value;\n      }\n    }\n  }\n\n  takeScreenShot() {\n    const newWindow = window.open(\"\", \"\");\n    newWindow.document.title = \"T3D Explorer Screenshot\";\n    const image = new Image();\n\n    this._threeContext.renderer.clear(this._threeContext.renderer.getClearColor());\n    // Render first skyCamera\n    this._threeContext.renderer.render(this._threeContext.skyScene, this._threeContext.skyCamera);\n    this._threeContext.renderer.render(this._threeContext.scene, this._threeContext.camera);\n    image.src = this._threeContext.renderer.domElement.toDataURL();\n    newWindow.document.body.appendChild(image);\n  }\n\n  setupController(controllerType = \"fly\") {\n    if (this._threeContext.controls) {\n      this._threeContext.controls.dispose();\n    }\n\n    if (controllerType === \"orbital\") {\n      this._threeContext.controls = new THREE.OrbitControls(\n        this._threeContext.camera,\n        this._threeContext.renderer.domElement\n      );\n\n      this._threeContext.controls.enableZoom = true;\n    } else if (controllerType === \"fly\") {\n      this._threeContext.controls = new THREE.FlyControls(\n        this._threeContext.camera,\n        this._threeContext.renderer.domElement\n      );\n\n      this._threeContext.controls.movementSpeed = this.movementSpeed;\n      this._threeContext.controls.rollSpeed = Math.PI / 6;\n      this._threeContext.controls.autoForward = false;\n      this._threeContext.controls.dragToLook = true;\n    } else {\n      throw new Error(\"Invalid controller type\");\n    }\n\n    this.controllerType = controllerType;\n  }\n\n  cleanupMap() {\n    this._mapContext = undefined;\n    this._renderOptions = undefined;\n    this.loadedMapID = undefined;\n    for (const mesh of this._mapMeshes) {\n      this._threeContext.scene.remove(mesh);\n    }\n    for (const skyBox of this._threeContext.skyScene.children) {\n      this._threeContext.skyScene.remove(skyBox);\n    }\n    this._mapMeshes = [];\n  }\n\n  setupScene() {\n    const { _threeContext: context } = this;\n\n    context.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100000);\n    context.skyCamera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100000);\n    context.scene = new THREE.Scene();\n    context.skyScene = new THREE.Scene();\n    context.clock = new THREE.Clock();\n\n    context.ambientLight = new THREE.AmbientLight(0x555555);\n    context.scene.add(context.ambientLight);\n\n    context.sceneLights = [\n      new THREE.DirectionalLight(0xffffff, this.lightIntensity),\n      new THREE.DirectionalLight(0xffffff, this.lightIntensity),\n      new THREE.DirectionalLight(0xffffff, this.lightIntensity),\n    ];\n    context.sceneLights[0].position.set(0, 0, 1);\n    context.sceneLights[0].position.set(0, 1, 0);\n    context.sceneLights[0].position.set(1, 0, 0);\n    for (const light of context.sceneLights) {\n      context.scene.add(light);\n    }\n\n    context.scene.fog = new THREE.Fog(0xffffff, this.fog, this.fog + FOG_LENGTH);\n    context.camera.far = this.fog + FOG_LENGTH;\n    context.camera.updateProjectionMatrix();\n\n    this.setupWebGLRenderer(true);\n    this.setupController();\n    this._render();\n  }\n\n  onWindowResize() {\n    const { _threeContext: context } = this;\n    if (context.renderer && context.camera && context.skyCamera) {\n      context.camera.aspect = window.innerWidth / window.innerHeight;\n      context.camera.updateProjectionMatrix();\n      context.renderer.setSize(window.innerWidth, window.innerHeight);\n      context.skyCamera.aspect = window.innerWidth / window.innerHeight;\n      context.skyCamera.updateProjectionMatrix();\n    }\n  }\n\n  // This function is safe to be called whenever the active webgl context is not rendering on screen\n  setupWebGLRenderer(hidden) {\n    const { _threeContext: context } = this;\n    const oldRenderer = context.renderer;\n    context.renderer = new THREE.WebGLRenderer(this.webGLRendererOptions);\n    context.renderer.autoClear = false;\n    context.renderer.setSize(window.innerWidth, window.innerHeight);\n    context.renderer.setClearColor(CANVAS_CLEAR_COLOR);\n    if (hidden) {\n      $(context.renderer.domElement).hide();\n    }\n    if (oldRenderer) {\n      $(oldRenderer.domElement).remove();\n    }\n    $(\"#explorer\").append(context.renderer.domElement);\n  }\n\n  getUrlData() {\n    const controls = this._threeContext.controls;\n    const pos = controls.object.position;\n    const rot = controls.object.rotation;\n    return {\n      map: this.loadedMapID,\n      x: Math.round(pos.x * 1000) / 1000,\n      y: Math.round(pos.y * 1000) / 1000,\n      z: Math.round(pos.z * 1000) / 1000,\n      rx: Math.round(rot.x * 10000) / 10000,\n      ry: Math.round(rot.y * 10000) / 10000,\n      rz: Math.round(rot.z * 10000) / 10000,\n      cameraType: this.controllerType,\n      loadZone: !!this._renderOptions.zone,\n      loadProp: !!this._renderOptions.props,\n      showHavok: !!this._renderOptions.collisions,\n      fog: this.fog,\n    };\n  }\n\n  /** PRIVATE methods */\n  _render() {\n    this.stats.update();\n    window.requestAnimationFrame(() => this._render());\n    this._threeContext.controls.update(this._threeContext.clock.getDelta());\n\n    this._threeContext.renderer.clear(this._threeContext.renderer.getClearColor());\n\n    // Render first skyCamera\n    this._threeContext.skyCamera.quaternion.copy(this._threeContext.camera.quaternion);\n    this._threeContext.renderer.render(this._threeContext.skyScene, this._threeContext.skyCamera);\n\n    this._threeContext.renderer.render(this._threeContext.scene, this._threeContext.camera);\n  }\n\n  _loadMapCallback(context, renderOptions, externalCallback) {\n    this._mapContext = context;\n\n    // Add all the data from the context to the threejs scene\n    for (const tile of T3D.getContextValue(context, T3D.TerrainRenderer, \"terrainTiles\")) {\n      this._threeContext.scene.add(tile);\n      this._mapMeshes.push(tile);\n    }\n    const water = T3D.getContextValue(context, T3D.TerrainRenderer, \"water\");\n    this._threeContext.scene.add(water);\n    this._mapMeshes.push(water);\n\n    const skyBox = T3D.getContextValue(context, T3D.EnvironmentRenderer, \"skyBox\");\n    this._threeContext.skyScene.add(skyBox);\n    const hazeColor = T3D.getContextValue(context, T3D.EnvironmentRenderer, \"hazeColor\");\n    if (hazeColor) {\n      this._threeContext.renderer.setClearColor(\n        new THREE.Color(hazeColor[2] / 255, hazeColor[1] / 255, hazeColor[0] / 255)\n      );\n    }\n\n    if (renderOptions.zone) {\n      for (const zoneModel of T3D.getContextValue(context, T3D.ZoneRenderer, \"meshes\")) {\n        this._threeContext.scene.add(zoneModel);\n        this._mapMeshes.push(zoneModel);\n      }\n    }\n    if (renderOptions.props) {\n      for (const propModel of T3D.getContextValue(context, T3D.PropertiesRenderer, \"meshes\")) {\n        this._threeContext.scene.add(propModel);\n        this._mapMeshes.push(propModel);\n      }\n    }\n    if (renderOptions.collisions) {\n      for (const collModel of T3D.getContextValue(context, T3D.HavokRenderer, \"meshes\")) {\n        this._threeContext.scene.add(collModel);\n        this._mapMeshes.push(collModel);\n      }\n    }\n\n    // Move camera\n    const bounds = T3D.getContextValue(context, T3D.TerrainRenderer, \"bounds\");\n    this._resetCameraLocation(bounds);\n\n    // If set fog is too small to see the map we increase it\n    if (this.fog < bounds.y2 * 1.5) {\n      this.setFogDistance(bounds.y2 * 2);\n    }\n\n    return externalCallback();\n  }\n\n  _resetCameraLocation(bounds) {\n    if (this.controllerType === \"fly\") {\n      this._threeContext.camera.position.x = 0;\n      this._threeContext.camera.position.y = bounds ? bounds.y2 : 0;\n      this._threeContext.camera.position.z = 0;\n      this._threeContext.camera.rotation.x = (-90 * Math.PI) / 180;\n    } else {\n      this._threeContext.camera.position.x = 0;\n      this._threeContext.camera.position.y = 0;\n      this._threeContext.camera.position.z = 0;\n    }\n  }\n}\n\nmodule.exports = AppRenderer;\n","class UI {\n  constructor(appRenderer) {\n    this.appRenderer = appRenderer;\n\n    this.showingProgress = false;\n    this.archiveLoaded = false;\n    this.mapFileList = [];\n    this.autoLoad = undefined;\n    this.shouldUpdateUrl = false;\n\n    this.urlUpdateInterval = setInterval(() => this.updateUrl(), 100);\n    this.lastUrlData = \"\";\n  }\n\n  init() {\n    this.appRenderer.setupScene();\n\n    T3D.Logger.logFunctions[T3D.Logger.TYPE_PROGRESS] = (name, value) => {\n      console.log(name, value);\n      if (this.showingProgress) {\n        $(\"#loadingName\").text(name);\n        $(\"#loadingValue\").text(`${value}%`);\n      }\n    };\n\n    T3D.Logger.logFunctions[T3D.Logger.TYPE_ERROR] = (error) => {\n      console.error(error);\n      // If we receive an error before the archive is loaded that means that parsing the archive failed\n      if (!this.archiveLoaded) {\n        $(\"#intro\").fadeIn();\n      }\n    };\n\n    this.setupIntro();\n    this.setupMapChoice();\n    this.setupMapExplorer();\n\n    this.appRenderer.setMovementSpeed(parseInt($(\"#mvntSpeedRange\").val(), 10));\n    this.appRenderer.setFogDistance(parseInt($(\"#fogRange\").val(), 10));\n    this.appRenderer.renderHook = (data) => this.updateUrl(data);\n\n    $(\"canvas\").on(\"wheel\", (event) => this.onMouseWheel(event));\n\n    this.checkAutoLoad();\n  }\n\n  /*\n   * SETUPS\n   */\n  setupIntro() {\n    $(\"#filePickerInput\").on(\"change\", (event) => this.onFileSelected(event));\n    $(\"#filePickerButton\").on(\"click\", () => $(\"#filePickerInput\").trigger(\"click\"));\n  }\n  setupMapChoice() {\n    $(\"#categorySelect\").on(\"change\", () => this.genMapSelect());\n    $(\"#mapLoadButton\").on(\"click\", () => this.onMapLoadClick());\n    $(\"#scanMapLink\").on(\"click\", () => this.onScanMapClick());\n  }\n  setupMapExplorer() {\n    $(\"#switchControllerType\").on(\"click\", () => {\n      if (this.appRenderer.controllerType === \"fly\") {\n        this.appRenderer.setupController(\"orbital\");\n      } else {\n        this.appRenderer.setupController(\"fly\");\n      }\n    });\n    $(\"#goToMapSelectButton\").on(\"click\", () => this.onBackToMapSelect());\n    $(\"#takeScreenshot\").on(\"click\", () => this.appRenderer.takeScreenShot());\n    $(\"#mvntSpeedRange\").on(\"change\", (event) => this.appRenderer.setMovementSpeed(event.target.valueAsNumber));\n    $(\"#fogRange\").on(\"change\", (event) => this.appRenderer.setFogDistance(event.target.valueAsNumber));\n\n    window.addEventListener(\"resize\", () => this.appRenderer.onWindowResize());\n  }\n\n  /*\n   * HANDLERS\n   */\n  onFileSelected(event) {\n    const file = event.target.files[0];\n    $(\"#intro\").slideUp(() => {\n      this.appRenderer.createLocalReader(file, async () => {\n        this.archiveLoaded = true;\n        this.mapFileList = await this.appRenderer.getMapList();\n        this.fillMapChoiceSelect();\n        // User might enter an non-existant ID so we only trigger autoload if we find the map\n        if (this.autoLoad && this.mapFileList.find((i) => i.baseId === this.autoLoad.map)) {\n          return this.onAutoLoad();\n        }\n        $(\"#choose-map\").fadeIn();\n      });\n    });\n  }\n\n  onAutoLoad() {\n    const mapId = this.autoLoad.map;\n    const renderOptions = {\n      zone: this.autoLoad.loadZone === undefined ? false : this.autoLoad.loadZone,\n      props: this.autoLoad.loadProp === undefined ? true : this.autoLoad.loadProp,\n      collisions: this.autoLoad.showHavok === undefined ? false : this.autoLoad.showHavok,\n    };\n    this.showingProgress = true;\n    $(\"#loading-ui\").fadeIn();\n    this.appRenderer.loadMap(mapId, renderOptions, () => {\n      this.appRenderer.setupController(this.autoLoad.cameraType || \"fly\");\n      this.appRenderer.move(this.autoLoad.x, this.autoLoad.y, this.autoLoad.z);\n      this.appRenderer.rotate(this.autoLoad.rx, this.autoLoad.ry, this.autoLoad.rz);\n      // Don't forget to cleanup autoLoad, if not it might break map choice UI\n      this.autoLoad = undefined;\n      this.onMapLoaded();\n    });\n  }\n\n  onMapLoadClick() {\n    // Anti aliasing option can only be enabled when creating the webgl context\n    // So we update that first if needed\n    const aaEnabled = $(\"#enableAA\").is(\":checked\");\n    if (this.appRenderer.webGLRendererOptions.antialiasing !== aaEnabled) {\n      this.appRenderer.webGLRendererOptions.antialiasing = aaEnabled;\n      this.appRenderer.setupWebGLRenderer(true);\n    }\n\n    const mapId = $(\"#mapSelect\").val();\n    const renderOptions = {\n      zone: $(\"#loadZone\").is(\":checked\"),\n      props: $(\"#loadProps\").is(\":checked\"),\n      collisions: $(\"#loadColl\").is(\":checked\"),\n    };\n    $(\"#choose-map\").slideUp(() => {\n      this.showingProgress = true;\n      $(\"#loading-ui\").fadeIn();\n    });\n    this.appRenderer.loadMap(mapId, renderOptions, () => {\n      // Reset the position of the camera if we already loaded a previous map\n      this.appRenderer.setupController();\n      this.onMapLoaded();\n    });\n  }\n\n  onMapLoaded() {\n    this.showingProgress = false;\n    $(\"#loading-ui\").slideUp(() => {\n      $(\"canvas\").fadeIn();\n      $(\"#controls\").fadeIn();\n      $(\"#loadingName\").text(\"Loading...\");\n      $(\"#loadingValue\").text(\"\");\n    });\n    // Sync the input ranges with their value in the appRenderer\n    $(\"#fogRange\").val(this.appRenderer.fog);\n    $(\"#mvntSpeedRange\").val(this.appRenderer.movementSpeed);\n    this.shouldUpdateUrl = true;\n  }\n\n  onBackToMapSelect() {\n    $(\"#controls\").slideUp(() => {\n      $(\"canvas\").hide(0);\n      $(\"#choose-map\").fadeIn();\n      this.appRenderer.cleanupMap();\n      this.updateUrl(true);\n      this.shouldUpdateUrl = false;\n    });\n  }\n\n  onFileScanDone() {\n    this.showingProgress = false;\n    $(\"#loading-ui\").slideUp(() => {\n      $(\"#choose-map\").fadeIn();\n      $(\"#loadingName\").text(\"Loading...\");\n      $(\"#loadingValue\").text(\"\");\n    });\n  }\n\n  onScanMapClick() {\n    $(\"#choose-map\").slideUp(() => {\n      $(\"#loadingName\").text(\"Scanning...\");\n      this.showingProgress = true;\n      $(\"#loading-ui\").fadeIn(async () => {\n        await this.appRenderer.scanArchiveForMaps();\n        this.mapFileList = await this.appRenderer.getMapList();\n        this.fillMapChoiceSelect();\n        this.onFileScanDone();\n      });\n    });\n  }\n\n  onMouseWheel(event) {\n    const newSpeed =\n      event.originalEvent.deltaY < 0\n        ? Math.min(this.appRenderer.movementSpeed + 100, 10000)\n        : Math.max(this.appRenderer.movementSpeed - 100, 500);\n\n    this.appRenderer.setMovementSpeed(newSpeed);\n    $(\"#mvntSpeedRange\").val(newSpeed);\n  }\n\n  /* UTILS */\n\n  /**\n   * This function generates the content of the map selector\n   * and NOT the category one\n   */\n  genMapSelect() {\n    const category = $(\"#categorySelect\").val();\n    $(\"#mapSelect\").empty();\n    for (const map of this.mapFileList) {\n      if (map.category === category) {\n        const opt = document.createElement(\"option\");\n        opt.value = map.baseId;\n        opt.innerHTML = map.name;\n        $(\"#mapSelect\").append(opt);\n      }\n    }\n  }\n\n  /**\n   * This function generates the content of the category selector\n   * and NOT the map one\n   */\n  fillMapChoiceSelect() {\n    const categoryList = this.mapFileList.reduce((categories, map) => {\n      if (categories.indexOf(map.category) === -1) {\n        categories.push(map.category);\n      }\n      return categories;\n    }, []);\n    for (const category of categoryList) {\n      const opt = document.createElement(\"option\");\n      opt.value = category;\n      opt.innerHTML = category;\n      $(\"#categorySelect\").append(opt);\n    }\n    this.genMapSelect();\n  }\n\n  updateUrl(shouldClear = false) {\n    if (this.shouldUpdateUrl) {\n      if (shouldClear) {\n        window.location.hash = \"\";\n      } else {\n        const urlData = $.param(this.appRenderer.getUrlData());\n        if (this.lastUrlData !== urlData) {\n          window.location.hash = urlData;\n          this.lastUrlData = urlData;\n        }\n      }\n    }\n  }\n\n  checkAutoLoad() {\n    const urlData = getParsedUrl();\n    if (urlData.map) {\n      this.autoLoad = urlData;\n    }\n  }\n}\n\nfunction getParsedUrl() {\n  const data = deparam(window.location.hash.slice(1));\n  data.map = data.map ? parseInt(data.map) : undefined;\n  data.x = data.x ? parseInt(data.x) : undefined;\n  data.y = data.y ? parseInt(data.y) : undefined;\n  data.z = data.z ? parseInt(data.z) : undefined;\n  data.rx = data.rx ? parseFloat(data.rx) : undefined;\n  data.ry = data.ry ? parseFloat(data.ry) : undefined;\n  data.rz = data.rz ? parseFloat(data.rz) : undefined;\n  data.loadZone = data.loadZone ? data.loadZone === \"true\" : undefined;\n  data.loadProp = data.loadProp ? data.loadProp === \"true\" : undefined;\n  data.showHavok = data.showHavok ? data.showHavok === \"true\" : undefined;\n  data.fog = data.fog ? parseInt(data.fog) : undefined;\n\n  // Backward compatibility with Tyria3DApp\n  if (data.pitch && data.yaw) {\n    const pitch = parseFloat(data.pitch);\n    const yaw = parseFloat(data.yaw);\n    // convert pitch yaw to xyz rotations:\n    data.rx = -Math.cos(yaw) * Math.cos(pitch);\n    data.ry = Math.sin(yaw) * Math.cos(pitch);\n    data.rz = -Math.sin(pitch);\n  }\n\n  return data;\n}\n\nfunction deparam(queryString) {\n  try {\n    const parameters = {};\n    const chunks = queryString.split(\"&\");\n    for (const chunk of chunks) {\n      const [key, value] = chunk.split(\"=\");\n      parameters[decodeURIComponent(key)] = decodeURIComponent(value);\n    }\n    return parameters;\n  } catch (error) {\n    console.error(error);\n    return {};\n  }\n}\n\nmodule.exports = UI;\n"],"preExistingComment":"//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJzcmMvaW5kZXguanMiLCJzcmMvcmVuZGVyZXIuanMiLCJzcmMvdWkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7Ozs7QUNsQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDblZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbigpe2Z1bmN0aW9uIHIoZSxuLHQpe2Z1bmN0aW9uIG8oaSxmKXtpZighbltpXSl7aWYoIWVbaV0pe3ZhciBjPVwiZnVuY3Rpb25cIj09dHlwZW9mIHJlcXVpcmUmJnJlcXVpcmU7aWYoIWYmJmMpcmV0dXJuIGMoaSwhMCk7aWYodSlyZXR1cm4gdShpLCEwKTt2YXIgYT1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK2krXCInXCIpO3Rocm93IGEuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixhfXZhciBwPW5baV09e2V4cG9ydHM6e319O2VbaV1bMF0uY2FsbChwLmV4cG9ydHMsZnVuY3Rpb24ocil7dmFyIG49ZVtpXVsxXVtyXTtyZXR1cm4gbyhufHxyKX0scCxwLmV4cG9ydHMscixlLG4sdCl9cmV0dXJuIG5baV0uZXhwb3J0c31mb3IodmFyIHU9XCJmdW5jdGlvblwiPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZSxpPTA7aTx0Lmxlbmd0aDtpKyspbyh0W2ldKTtyZXR1cm4gb31yZXR1cm4gcn0pKCkiLCJjb25zdCBBcHBSZW5kZXJlciA9IHJlcXVpcmUoXCIuL3JlbmRlcmVyXCIpO1xuY29uc3QgVUkgPSByZXF1aXJlKFwiLi91aVwiKTtcblxuY29uc3Qgc3RhdHMgPSBuZXcgU3RhdHMoKTtcbiQoXCJib2R5XCIpLmFwcGVuZChzdGF0cy5kb21FbGVtZW50KTtcbiQoc3RhdHMuZG9tRWxlbWVudCkuaGlkZSgpO1xuc3RhdHMudG9nZ2xlID0gKCkgPT4gJChzdGF0cy5kb21FbGVtZW50KS50b2dnbGUoKTtcblxuY29uc3QgYXBwUmVuZGVyZXIgPSBuZXcgQXBwUmVuZGVyZXIoc3RhdHMpO1xuY29uc3QgdWkgPSBuZXcgVUkoYXBwUmVuZGVyZXIpO1xuXG51aS5pbml0KCk7XG5cbi8vIEFsbG93IHVzZXIgdG8gYWNjZXNzIGFwcFJlbmRlcmVyXG4vLyBUaGlzIGlzIG5vdCB1c2VkIGJ5IHRoZSBhcHAgaXRzZWxmXG5nbG9iYWwuYXBwUmVuZGVyZXIgPSBhcHBSZW5kZXJlcjtcbmdsb2JhbC51aSA9IHVpO1xuZ2xvYmFsLnN0YXRzID0gc3RhdHM7XG4iLCJjb25zdCBDQU5WQVNfQ0xFQVJfQ09MT1IgPSAweDM0MjkyMDtcbmNvbnN0IEZPR19MRU5HVEggPSA1MDAwO1xuXG5jbGFzcyBBcHBSZW5kZXJlciB7XG4gIGNvbnN0cnVjdG9yKHN0YXRzKSB7XG4gICAgdGhpcy5sb2NhbFJlYWRlciA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLl90aHJlZUNvbnRleHQgPSB7fTtcbiAgICB0aGlzLl9tYXBNZXNoZXMgPSBbXTtcbiAgICB0aGlzLl9tYXBDb250ZXh0ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuX3JlbmRlck9wdGlvbnMgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5zdGF0cyA9IHN0YXRzO1xuXG4gICAgLy8gRGVmYXVsdHNcbiAgICB0aGlzLmZvZyA9IDI1MDAwO1xuICAgIHRoaXMubW92ZW1lbnRTcGVlZCA9IDEwMDAwO1xuICAgIHRoaXMubGlnaHRJbnRlbnNpdHkgPSAwLjU7XG4gICAgdGhpcy5sb2FkZWRNYXBJRCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmNvbnRyb2xsZXJUeXBlID0gXCJmbHlcIjtcblxuICAgIHRoaXMud2ViR0xSZW5kZXJlck9wdGlvbnMgPSB7XG4gICAgICBzb3J0T2JqZWN0czogZmFsc2UsXG4gICAgICBsb2dhcml0aG1pY0RlcHRoQnVmZmVyOiB0cnVlLFxuICAgICAgc3RlbmNpbDogZmFsc2UsXG4gICAgICBwcmVtdWx0aXBsaWVkQWxwaGE6IGZhbHNlLFxuICAgICAgYW50aWFsaWFzaW5nOiB0cnVlLFxuICAgIH07XG4gIH1cblxuICAvKiogUFVCTElDIG1ldGhvZHMgKi9cbiAgY3JlYXRlTG9jYWxSZWFkZXIoZmlsZSwgY2FsbGJhY2spIHtcbiAgICB0aGlzLmxvY2FsUmVhZGVyID0gVDNELmdldExvY2FsUmVhZGVyKGZpbGUsIGNhbGxiYWNrLCBcIi4vc3RhdGljL3QzZHdvcmtlci5qc1wiKTtcbiAgfVxuXG4gIGdldE1hcExpc3QoKSB7XG4gICAgcmV0dXJuIHRoaXMubG9jYWxSZWFkZXIuZ2V0TWFwTGlzdCgpO1xuICB9XG5cbiAgc2NhbkFyY2hpdmVGb3JNYXBzKCkge1xuICAgIHJldHVybiB0aGlzLmxvY2FsUmVhZGVyLnJlYWRGaWxlTGlzdCgpO1xuICB9XG5cbiAgbG9hZE1hcChtYXBJZCwgcmVuZGVyT3B0aW9ucywgY2FsbGJhY2spIHtcbiAgICBpZiAodGhpcy5sb2FkZWRNYXBJRCkge1xuICAgICAgdGhpcy5jbGVhbnVwTWFwKCk7XG4gICAgfVxuXG4gICAgdGhpcy5sb2FkZWRNYXBJRCA9IG1hcElkO1xuICAgIHRoaXMuX3JlbmRlck9wdGlvbnMgPSByZW5kZXJPcHRpb25zO1xuXG4gICAgY29uc3QgcmVuZGVyZXJzID0gW1xuICAgICAgeyByZW5kZXJDbGFzczogVDNELkVudmlyb25tZW50UmVuZGVyZXIsIHNldHRpbmdzOiB7fSB9LFxuICAgICAgeyByZW5kZXJDbGFzczogVDNELlRlcnJhaW5SZW5kZXJlciwgc2V0dGluZ3M6IHt9IH0sXG4gICAgXTtcblxuICAgIGlmIChyZW5kZXJPcHRpb25zLnpvbmUpIHtcbiAgICAgIHJlbmRlcmVycy5wdXNoKHsgcmVuZGVyQ2xhc3M6IFQzRC5ab25lUmVuZGVyZXIsIHNldHRpbmdzOiB7IHZpc2libGU6IHRydWUgfSB9KTtcbiAgICB9XG4gICAgaWYgKHJlbmRlck9wdGlvbnMucHJvcHMpIHtcbiAgICAgIHJlbmRlcmVycy5wdXNoKHsgcmVuZGVyQ2xhc3M6IFQzRC5Qcm9wZXJ0aWVzUmVuZGVyZXIsIHNldHRpbmdzOiB7IHZpc2libGU6IHRydWUgfSB9KTtcbiAgICB9XG4gICAgaWYgKHJlbmRlck9wdGlvbnMuY29sbGlzaW9ucykge1xuICAgICAgcmVuZGVyZXJzLnB1c2goeyByZW5kZXJDbGFzczogVDNELkhhdm9rUmVuZGVyZXIsIHNldHRpbmdzOiB7IHZpc2libGU6IHRydWUgfSB9KTtcbiAgICB9XG5cbiAgICBUM0QucmVuZGVyTWFwQ29udGVudHNBc3luYyh0aGlzLmxvY2FsUmVhZGVyLCB0aGlzLmxvYWRlZE1hcElELCByZW5kZXJlcnMsIChjb250ZXh0KSA9PiB7XG4gICAgICB0aGlzLl9sb2FkTWFwQ2FsbGJhY2soY29udGV4dCwgcmVuZGVyT3B0aW9ucywgY2FsbGJhY2spO1xuICAgIH0pO1xuICB9XG5cbiAgc2V0Rm9nRGlzdGFuY2UodmFsdWUpIHtcbiAgICB0aGlzLmZvZyA9IHZhbHVlO1xuICAgIGlmICh0aGlzLl90aHJlZUNvbnRleHQuc2NlbmUgJiYgdGhpcy5fdGhyZWVDb250ZXh0LnNjZW5lLmZvZykge1xuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LnNjZW5lLmZvZy5uZWFyID0gdGhpcy5mb2c7XG4gICAgICB0aGlzLl90aHJlZUNvbnRleHQuc2NlbmUuZm9nLmZhciA9IHRoaXMuZm9nICsgRk9HX0xFTkdUSDtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3RocmVlQ29udGV4dC5jYW1lcmEpIHtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5jYW1lcmEuZmFyID0gdGhpcy5mb2cgKyBGT0dfTEVOR1RIO1xuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7XG4gICAgfVxuICB9XG5cbiAgc2V0TW92ZW1lbnRTcGVlZCh2YWx1ZSkge1xuICAgIHRoaXMubW92ZW1lbnRTcGVlZCA9IHZhbHVlO1xuICAgIGlmICh0aGlzLl90aHJlZUNvbnRleHQuY29udHJvbHMpIHtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5jb250cm9scy5tb3ZlbWVudFNwZWVkID0gdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgbW92ZSh4LCB5LCB6KSB7XG4gICAgaWYgKHgpIHtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5jb250cm9scy5vYmplY3QucG9zaXRpb24ueCA9IHg7XG4gICAgfVxuICAgIGlmICh5KSB7XG4gICAgICB0aGlzLl90aHJlZUNvbnRleHQuY29udHJvbHMub2JqZWN0LnBvc2l0aW9uLnkgPSB5O1xuICAgIH1cbiAgICBpZiAoeikge1xuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LmNvbnRyb2xzLm9iamVjdC5wb3NpdGlvbi56ID0gejtcbiAgICB9XG4gIH1cblxuICByb3RhdGUocngsIHJ5LCByeikge1xuICAgIGlmIChyeCkge1xuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LmNvbnRyb2xzLm9iamVjdC5yb3RhdGlvbi54ID0gcng7XG4gICAgfVxuICAgIGlmIChyeSkge1xuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LmNvbnRyb2xzLm9iamVjdC5yb3RhdGlvbi55ID0gcnk7XG4gICAgfVxuICAgIGlmIChyeikge1xuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LmNvbnRyb2xzLm9iamVjdC5yb3RhdGlvbi56ID0gcno7XG4gICAgfVxuICB9XG5cbiAgc2V0TGlnaHRJbnRlbnNpdHkodmFsdWUpIHtcbiAgICB0aGlzLmxpZ2h0SW50ZW5zaXR5ID0gdmFsdWU7XG4gICAgaWYgKHRoaXMuX3RocmVlQ29udGV4dC5zY2VuZUxpZ2h0cykge1xuICAgICAgZm9yIChjb25zdCBsaWdodCBvZiB0aGlzLl90aHJlZUNvbnRleHQuc2NlbmVMaWdodHMpIHtcbiAgICAgICAgbGlnaHQuaW50ZW5zaXR5ID0gdmFsdWU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgdGFrZVNjcmVlblNob3QoKSB7XG4gICAgY29uc3QgbmV3V2luZG93ID0gd2luZG93Lm9wZW4oXCJcIiwgXCJcIik7XG4gICAgbmV3V2luZG93LmRvY3VtZW50LnRpdGxlID0gXCJUM0QgRXhwbG9yZXIgU2NyZWVuc2hvdFwiO1xuICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKCk7XG5cbiAgICB0aGlzLl90aHJlZUNvbnRleHQucmVuZGVyZXIuY2xlYXIodGhpcy5fdGhyZWVDb250ZXh0LnJlbmRlcmVyLmdldENsZWFyQ29sb3IoKSk7XG4gICAgLy8gUmVuZGVyIGZpcnN0IHNreUNhbWVyYVxuICAgIHRoaXMuX3RocmVlQ29udGV4dC5yZW5kZXJlci5yZW5kZXIodGhpcy5fdGhyZWVDb250ZXh0LnNreVNjZW5lLCB0aGlzLl90aHJlZUNvbnRleHQuc2t5Q2FtZXJhKTtcbiAgICB0aGlzLl90aHJlZUNvbnRleHQucmVuZGVyZXIucmVuZGVyKHRoaXMuX3RocmVlQ29udGV4dC5zY2VuZSwgdGhpcy5fdGhyZWVDb250ZXh0LmNhbWVyYSk7XG4gICAgaW1hZ2Uuc3JjID0gdGhpcy5fdGhyZWVDb250ZXh0LnJlbmRlcmVyLmRvbUVsZW1lbnQudG9EYXRhVVJMKCk7XG4gICAgbmV3V2luZG93LmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaW1hZ2UpO1xuICB9XG5cbiAgc2V0dXBDb250cm9sbGVyKGNvbnRyb2xsZXJUeXBlID0gXCJmbHlcIikge1xuICAgIGlmICh0aGlzLl90aHJlZUNvbnRleHQuY29udHJvbHMpIHtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5jb250cm9scy5kaXNwb3NlKCk7XG4gICAgfVxuXG4gICAgaWYgKGNvbnRyb2xsZXJUeXBlID09PSBcIm9yYml0YWxcIikge1xuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LmNvbnRyb2xzID0gbmV3IFRIUkVFLk9yYml0Q29udHJvbHMoXG4gICAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5jYW1lcmEsXG4gICAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5yZW5kZXJlci5kb21FbGVtZW50XG4gICAgICApO1xuXG4gICAgICB0aGlzLl90aHJlZUNvbnRleHQuY29udHJvbHMuZW5hYmxlWm9vbSA9IHRydWU7XG4gICAgfSBlbHNlIGlmIChjb250cm9sbGVyVHlwZSA9PT0gXCJmbHlcIikge1xuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LmNvbnRyb2xzID0gbmV3IFRIUkVFLkZseUNvbnRyb2xzKFxuICAgICAgICB0aGlzLl90aHJlZUNvbnRleHQuY2FtZXJhLFxuICAgICAgICB0aGlzLl90aHJlZUNvbnRleHQucmVuZGVyZXIuZG9tRWxlbWVudFxuICAgICAgKTtcblxuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LmNvbnRyb2xzLm1vdmVtZW50U3BlZWQgPSB0aGlzLm1vdmVtZW50U3BlZWQ7XG4gICAgICB0aGlzLl90aHJlZUNvbnRleHQuY29udHJvbHMucm9sbFNwZWVkID0gTWF0aC5QSSAvIDY7XG4gICAgICB0aGlzLl90aHJlZUNvbnRleHQuY29udHJvbHMuYXV0b0ZvcndhcmQgPSBmYWxzZTtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5jb250cm9scy5kcmFnVG9Mb29rID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBjb250cm9sbGVyIHR5cGVcIik7XG4gICAgfVxuXG4gICAgdGhpcy5jb250cm9sbGVyVHlwZSA9IGNvbnRyb2xsZXJUeXBlO1xuICB9XG5cbiAgY2xlYW51cE1hcCgpIHtcbiAgICB0aGlzLl9tYXBDb250ZXh0ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuX3JlbmRlck9wdGlvbnMgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5sb2FkZWRNYXBJRCA9IHVuZGVmaW5lZDtcbiAgICBmb3IgKGNvbnN0IG1lc2ggb2YgdGhpcy5fbWFwTWVzaGVzKSB7XG4gICAgICB0aGlzLl90aHJlZUNvbnRleHQuc2NlbmUucmVtb3ZlKG1lc2gpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IHNreUJveCBvZiB0aGlzLl90aHJlZUNvbnRleHQuc2t5U2NlbmUuY2hpbGRyZW4pIHtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5za3lTY2VuZS5yZW1vdmUoc2t5Qm94KTtcbiAgICB9XG4gICAgdGhpcy5fbWFwTWVzaGVzID0gW107XG4gIH1cblxuICBzZXR1cFNjZW5lKCkge1xuICAgIGNvbnN0IHsgX3RocmVlQ29udGV4dDogY29udGV4dCB9ID0gdGhpcztcblxuICAgIGNvbnRleHQuY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDYwLCB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodCwgMC4xLCAxMDAwMDApO1xuICAgIGNvbnRleHQuc2t5Q2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDYwLCB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodCwgMC4xLCAxMDAwMDApO1xuICAgIGNvbnRleHQuc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTtcbiAgICBjb250ZXh0LnNreVNjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7XG4gICAgY29udGV4dC5jbG9jayA9IG5ldyBUSFJFRS5DbG9jaygpO1xuXG4gICAgY29udGV4dC5hbWJpZW50TGlnaHQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4NTU1NTU1KTtcbiAgICBjb250ZXh0LnNjZW5lLmFkZChjb250ZXh0LmFtYmllbnRMaWdodCk7XG5cbiAgICBjb250ZXh0LnNjZW5lTGlnaHRzID0gW1xuICAgICAgbmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHQoMHhmZmZmZmYsIHRoaXMubGlnaHRJbnRlbnNpdHkpLFxuICAgICAgbmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHQoMHhmZmZmZmYsIHRoaXMubGlnaHRJbnRlbnNpdHkpLFxuICAgICAgbmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHQoMHhmZmZmZmYsIHRoaXMubGlnaHRJbnRlbnNpdHkpLFxuICAgIF07XG4gICAgY29udGV4dC5zY2VuZUxpZ2h0c1swXS5wb3NpdGlvbi5zZXQoMCwgMCwgMSk7XG4gICAgY29udGV4dC5zY2VuZUxpZ2h0c1swXS5wb3NpdGlvbi5zZXQoMCwgMSwgMCk7XG4gICAgY29udGV4dC5zY2VuZUxpZ2h0c1swXS5wb3NpdGlvbi5zZXQoMSwgMCwgMCk7XG4gICAgZm9yIChjb25zdCBsaWdodCBvZiBjb250ZXh0LnNjZW5lTGlnaHRzKSB7XG4gICAgICBjb250ZXh0LnNjZW5lLmFkZChsaWdodCk7XG4gICAgfVxuXG4gICAgY29udGV4dC5zY2VuZS5mb2cgPSBuZXcgVEhSRUUuRm9nKDB4ZmZmZmZmLCB0aGlzLmZvZywgdGhpcy5mb2cgKyBGT0dfTEVOR1RIKTtcbiAgICBjb250ZXh0LmNhbWVyYS5mYXIgPSB0aGlzLmZvZyArIEZPR19MRU5HVEg7XG4gICAgY29udGV4dC5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpO1xuXG4gICAgdGhpcy5zZXR1cFdlYkdMUmVuZGVyZXIodHJ1ZSk7XG4gICAgdGhpcy5zZXR1cENvbnRyb2xsZXIoKTtcbiAgICB0aGlzLl9yZW5kZXIoKTtcbiAgfVxuXG4gIG9uV2luZG93UmVzaXplKCkge1xuICAgIGNvbnN0IHsgX3RocmVlQ29udGV4dDogY29udGV4dCB9ID0gdGhpcztcbiAgICBpZiAoY29udGV4dC5yZW5kZXJlciAmJiBjb250ZXh0LmNhbWVyYSAmJiBjb250ZXh0LnNreUNhbWVyYSkge1xuICAgICAgY29udGV4dC5jYW1lcmEuYXNwZWN0ID0gd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQ7XG4gICAgICBjb250ZXh0LmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7XG4gICAgICBjb250ZXh0LnJlbmRlcmVyLnNldFNpemUod2luZG93LmlubmVyV2lkdGgsIHdpbmRvdy5pbm5lckhlaWdodCk7XG4gICAgICBjb250ZXh0LnNreUNhbWVyYS5hc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDtcbiAgICAgIGNvbnRleHQuc2t5Q2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTtcbiAgICB9XG4gIH1cblxuICAvLyBUaGlzIGZ1bmN0aW9uIGlzIHNhZmUgdG8gYmUgY2FsbGVkIHdoZW5ldmVyIHRoZSBhY3RpdmUgd2ViZ2wgY29udGV4dCBpcyBub3QgcmVuZGVyaW5nIG9uIHNjcmVlblxuICBzZXR1cFdlYkdMUmVuZGVyZXIoaGlkZGVuKSB7XG4gICAgY29uc3QgeyBfdGhyZWVDb250ZXh0OiBjb250ZXh0IH0gPSB0aGlzO1xuICAgIGNvbnN0IG9sZFJlbmRlcmVyID0gY29udGV4dC5yZW5kZXJlcjtcbiAgICBjb250ZXh0LnJlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIodGhpcy53ZWJHTFJlbmRlcmVyT3B0aW9ucyk7XG4gICAgY29udGV4dC5yZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTtcbiAgICBjb250ZXh0LnJlbmRlcmVyLnNldFNpemUod2luZG93LmlubmVyV2lkdGgsIHdpbmRvdy5pbm5lckhlaWdodCk7XG4gICAgY29udGV4dC5yZW5kZXJlci5zZXRDbGVhckNvbG9yKENBTlZBU19DTEVBUl9DT0xPUik7XG4gICAgaWYgKGhpZGRlbikge1xuICAgICAgJChjb250ZXh0LnJlbmRlcmVyLmRvbUVsZW1lbnQpLmhpZGUoKTtcbiAgICB9XG4gICAgaWYgKG9sZFJlbmRlcmVyKSB7XG4gICAgICAkKG9sZFJlbmRlcmVyLmRvbUVsZW1lbnQpLnJlbW92ZSgpO1xuICAgIH1cbiAgICAkKFwiI2V4cGxvcmVyXCIpLmFwcGVuZChjb250ZXh0LnJlbmRlcmVyLmRvbUVsZW1lbnQpO1xuICB9XG5cbiAgZ2V0VXJsRGF0YSgpIHtcbiAgICBjb25zdCBjb250cm9scyA9IHRoaXMuX3RocmVlQ29udGV4dC5jb250cm9scztcbiAgICBjb25zdCBwb3MgPSBjb250cm9scy5vYmplY3QucG9zaXRpb247XG4gICAgY29uc3Qgcm90ID0gY29udHJvbHMub2JqZWN0LnJvdGF0aW9uO1xuICAgIHJldHVybiB7XG4gICAgICBtYXA6IHRoaXMubG9hZGVkTWFwSUQsXG4gICAgICB4OiBNYXRoLnJvdW5kKHBvcy54ICogMTAwMCkgLyAxMDAwLFxuICAgICAgeTogTWF0aC5yb3VuZChwb3MueSAqIDEwMDApIC8gMTAwMCxcbiAgICAgIHo6IE1hdGgucm91bmQocG9zLnogKiAxMDAwKSAvIDEwMDAsXG4gICAgICByeDogTWF0aC5yb3VuZChyb3QueCAqIDEwMDAwKSAvIDEwMDAwLFxuICAgICAgcnk6IE1hdGgucm91bmQocm90LnkgKiAxMDAwMCkgLyAxMDAwMCxcbiAgICAgIHJ6OiBNYXRoLnJvdW5kKHJvdC56ICogMTAwMDApIC8gMTAwMDAsXG4gICAgICBjYW1lcmFUeXBlOiB0aGlzLmNvbnRyb2xsZXJUeXBlLFxuICAgICAgbG9hZFpvbmU6ICEhdGhpcy5fcmVuZGVyT3B0aW9ucy56b25lLFxuICAgICAgbG9hZFByb3A6ICEhdGhpcy5fcmVuZGVyT3B0aW9ucy5wcm9wcyxcbiAgICAgIHNob3dIYXZvazogISF0aGlzLl9yZW5kZXJPcHRpb25zLmNvbGxpc2lvbnMsXG4gICAgICBmb2c6IHRoaXMuZm9nLFxuICAgIH07XG4gIH1cblxuICAvKiogUFJJVkFURSBtZXRob2RzICovXG4gIF9yZW5kZXIoKSB7XG4gICAgdGhpcy5zdGF0cy51cGRhdGUoKTtcbiAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMuX3JlbmRlcigpKTtcbiAgICB0aGlzLl90aHJlZUNvbnRleHQuY29udHJvbHMudXBkYXRlKHRoaXMuX3RocmVlQ29udGV4dC5jbG9jay5nZXREZWx0YSgpKTtcblxuICAgIHRoaXMuX3RocmVlQ29udGV4dC5yZW5kZXJlci5jbGVhcih0aGlzLl90aHJlZUNvbnRleHQucmVuZGVyZXIuZ2V0Q2xlYXJDb2xvcigpKTtcblxuICAgIC8vIFJlbmRlciBmaXJzdCBza3lDYW1lcmFcbiAgICB0aGlzLl90aHJlZUNvbnRleHQuc2t5Q2FtZXJhLnF1YXRlcm5pb24uY29weSh0aGlzLl90aHJlZUNvbnRleHQuY2FtZXJhLnF1YXRlcm5pb24pO1xuICAgIHRoaXMuX3RocmVlQ29udGV4dC5yZW5kZXJlci5yZW5kZXIodGhpcy5fdGhyZWVDb250ZXh0LnNreVNjZW5lLCB0aGlzLl90aHJlZUNvbnRleHQuc2t5Q2FtZXJhKTtcblxuICAgIHRoaXMuX3RocmVlQ29udGV4dC5yZW5kZXJlci5yZW5kZXIodGhpcy5fdGhyZWVDb250ZXh0LnNjZW5lLCB0aGlzLl90aHJlZUNvbnRleHQuY2FtZXJhKTtcbiAgfVxuXG4gIF9sb2FkTWFwQ2FsbGJhY2soY29udGV4dCwgcmVuZGVyT3B0aW9ucywgZXh0ZXJuYWxDYWxsYmFjaykge1xuICAgIHRoaXMuX21hcENvbnRleHQgPSBjb250ZXh0O1xuXG4gICAgLy8gQWRkIGFsbCB0aGUgZGF0YSBmcm9tIHRoZSBjb250ZXh0IHRvIHRoZSB0aHJlZWpzIHNjZW5lXG4gICAgZm9yIChjb25zdCB0aWxlIG9mIFQzRC5nZXRDb250ZXh0VmFsdWUoY29udGV4dCwgVDNELlRlcnJhaW5SZW5kZXJlciwgXCJ0ZXJyYWluVGlsZXNcIikpIHtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5zY2VuZS5hZGQodGlsZSk7XG4gICAgICB0aGlzLl9tYXBNZXNoZXMucHVzaCh0aWxlKTtcbiAgICB9XG4gICAgY29uc3Qgd2F0ZXIgPSBUM0QuZ2V0Q29udGV4dFZhbHVlKGNvbnRleHQsIFQzRC5UZXJyYWluUmVuZGVyZXIsIFwid2F0ZXJcIik7XG4gICAgdGhpcy5fdGhyZWVDb250ZXh0LnNjZW5lLmFkZCh3YXRlcik7XG4gICAgdGhpcy5fbWFwTWVzaGVzLnB1c2god2F0ZXIpO1xuXG4gICAgY29uc3Qgc2t5Qm94ID0gVDNELmdldENvbnRleHRWYWx1ZShjb250ZXh0LCBUM0QuRW52aXJvbm1lbnRSZW5kZXJlciwgXCJza3lCb3hcIik7XG4gICAgdGhpcy5fdGhyZWVDb250ZXh0LnNreVNjZW5lLmFkZChza3lCb3gpO1xuICAgIGNvbnN0IGhhemVDb2xvciA9IFQzRC5nZXRDb250ZXh0VmFsdWUoY29udGV4dCwgVDNELkVudmlyb25tZW50UmVuZGVyZXIsIFwiaGF6ZUNvbG9yXCIpO1xuICAgIGlmIChoYXplQ29sb3IpIHtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5yZW5kZXJlci5zZXRDbGVhckNvbG9yKFxuICAgICAgICBuZXcgVEhSRUUuQ29sb3IoaGF6ZUNvbG9yWzJdIC8gMjU1LCBoYXplQ29sb3JbMV0gLyAyNTUsIGhhemVDb2xvclswXSAvIDI1NSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHJlbmRlck9wdGlvbnMuem9uZSkge1xuICAgICAgZm9yIChjb25zdCB6b25lTW9kZWwgb2YgVDNELmdldENvbnRleHRWYWx1ZShjb250ZXh0LCBUM0QuWm9uZVJlbmRlcmVyLCBcIm1lc2hlc1wiKSkge1xuICAgICAgICB0aGlzLl90aHJlZUNvbnRleHQuc2NlbmUuYWRkKHpvbmVNb2RlbCk7XG4gICAgICAgIHRoaXMuX21hcE1lc2hlcy5wdXNoKHpvbmVNb2RlbCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChyZW5kZXJPcHRpb25zLnByb3BzKSB7XG4gICAgICBmb3IgKGNvbnN0IHByb3BNb2RlbCBvZiBUM0QuZ2V0Q29udGV4dFZhbHVlKGNvbnRleHQsIFQzRC5Qcm9wZXJ0aWVzUmVuZGVyZXIsIFwibWVzaGVzXCIpKSB7XG4gICAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5zY2VuZS5hZGQocHJvcE1vZGVsKTtcbiAgICAgICAgdGhpcy5fbWFwTWVzaGVzLnB1c2gocHJvcE1vZGVsKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHJlbmRlck9wdGlvbnMuY29sbGlzaW9ucykge1xuICAgICAgZm9yIChjb25zdCBjb2xsTW9kZWwgb2YgVDNELmdldENvbnRleHRWYWx1ZShjb250ZXh0LCBUM0QuSGF2b2tSZW5kZXJlciwgXCJtZXNoZXNcIikpIHtcbiAgICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LnNjZW5lLmFkZChjb2xsTW9kZWwpO1xuICAgICAgICB0aGlzLl9tYXBNZXNoZXMucHVzaChjb2xsTW9kZWwpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE1vdmUgY2FtZXJhXG4gICAgY29uc3QgYm91bmRzID0gVDNELmdldENvbnRleHRWYWx1ZShjb250ZXh0LCBUM0QuVGVycmFpblJlbmRlcmVyLCBcImJvdW5kc1wiKTtcbiAgICB0aGlzLl9yZXNldENhbWVyYUxvY2F0aW9uKGJvdW5kcyk7XG5cbiAgICAvLyBJZiBzZXQgZm9nIGlzIHRvbyBzbWFsbCB0byBzZWUgdGhlIG1hcCB3ZSBpbmNyZWFzZSBpdFxuICAgIGlmICh0aGlzLmZvZyA8IGJvdW5kcy55MiAqIDEuNSkge1xuICAgICAgdGhpcy5zZXRGb2dEaXN0YW5jZShib3VuZHMueTIgKiAyKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZXh0ZXJuYWxDYWxsYmFjaygpO1xuICB9XG5cbiAgX3Jlc2V0Q2FtZXJhTG9jYXRpb24oYm91bmRzKSB7XG4gICAgaWYgKHRoaXMuY29udHJvbGxlclR5cGUgPT09IFwiZmx5XCIpIHtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5jYW1lcmEucG9zaXRpb24ueCA9IDA7XG4gICAgICB0aGlzLl90aHJlZUNvbnRleHQuY2FtZXJhLnBvc2l0aW9uLnkgPSBib3VuZHMgPyBib3VuZHMueTIgOiAwO1xuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LmNhbWVyYS5wb3NpdGlvbi56ID0gMDtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5jYW1lcmEucm90YXRpb24ueCA9ICgtOTAgKiBNYXRoLlBJKSAvIDE4MDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fdGhyZWVDb250ZXh0LmNhbWVyYS5wb3NpdGlvbi54ID0gMDtcbiAgICAgIHRoaXMuX3RocmVlQ29udGV4dC5jYW1lcmEucG9zaXRpb24ueSA9IDA7XG4gICAgICB0aGlzLl90aHJlZUNvbnRleHQuY2FtZXJhLnBvc2l0aW9uLnogPSAwO1xuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEFwcFJlbmRlcmVyO1xuIiwiY2xhc3MgVUkge1xuICBjb25zdHJ1Y3RvcihhcHBSZW5kZXJlcikge1xuICAgIHRoaXMuYXBwUmVuZGVyZXIgPSBhcHBSZW5kZXJlcjtcblxuICAgIHRoaXMuc2hvd2luZ1Byb2dyZXNzID0gZmFsc2U7XG4gICAgdGhpcy5hcmNoaXZlTG9hZGVkID0gZmFsc2U7XG4gICAgdGhpcy5tYXBGaWxlTGlzdCA9IFtdO1xuICAgIHRoaXMuYXV0b0xvYWQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5zaG91bGRVcGRhdGVVcmwgPSBmYWxzZTtcblxuICAgIHRoaXMudXJsVXBkYXRlSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzLnVwZGF0ZVVybCgpLCAxMDApO1xuICAgIHRoaXMubGFzdFVybERhdGEgPSBcIlwiO1xuICB9XG5cbiAgaW5pdCgpIHtcbiAgICB0aGlzLmFwcFJlbmRlcmVyLnNldHVwU2NlbmUoKTtcblxuICAgIFQzRC5Mb2dnZXIubG9nRnVuY3Rpb25zW1QzRC5Mb2dnZXIuVFlQRV9QUk9HUkVTU10gPSAobmFtZSwgdmFsdWUpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKG5hbWUsIHZhbHVlKTtcbiAgICAgIGlmICh0aGlzLnNob3dpbmdQcm9ncmVzcykge1xuICAgICAgICAkKFwiI2xvYWRpbmdOYW1lXCIpLnRleHQobmFtZSk7XG4gICAgICAgICQoXCIjbG9hZGluZ1ZhbHVlXCIpLnRleHQoYCR7dmFsdWV9JWApO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBUM0QuTG9nZ2VyLmxvZ0Z1bmN0aW9uc1tUM0QuTG9nZ2VyLlRZUEVfRVJST1JdID0gKGVycm9yKSA9PiB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgIC8vIElmIHdlIHJlY2VpdmUgYW4gZXJyb3IgYmVmb3JlIHRoZSBhcmNoaXZlIGlzIGxvYWRlZCB0aGF0IG1lYW5zIHRoYXQgcGFyc2luZyB0aGUgYXJjaGl2ZSBmYWlsZWRcbiAgICAgIGlmICghdGhpcy5hcmNoaXZlTG9hZGVkKSB7XG4gICAgICAgICQoXCIjaW50cm9cIikuZmFkZUluKCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMuc2V0dXBJbnRybygpO1xuICAgIHRoaXMuc2V0dXBNYXBDaG9pY2UoKTtcbiAgICB0aGlzLnNldHVwTWFwRXhwbG9yZXIoKTtcblxuICAgIHRoaXMuYXBwUmVuZGVyZXIuc2V0TW92ZW1lbnRTcGVlZChwYXJzZUludCgkKFwiI212bnRTcGVlZFJhbmdlXCIpLnZhbCgpLCAxMCkpO1xuICAgIHRoaXMuYXBwUmVuZGVyZXIuc2V0Rm9nRGlzdGFuY2UocGFyc2VJbnQoJChcIiNmb2dSYW5nZVwiKS52YWwoKSwgMTApKTtcbiAgICB0aGlzLmFwcFJlbmRlcmVyLnJlbmRlckhvb2sgPSAoZGF0YSkgPT4gdGhpcy51cGRhdGVVcmwoZGF0YSk7XG5cbiAgICAkKFwiY2FudmFzXCIpLm9uKFwid2hlZWxcIiwgKGV2ZW50KSA9PiB0aGlzLm9uTW91c2VXaGVlbChldmVudCkpO1xuXG4gICAgdGhpcy5jaGVja0F1dG9Mb2FkKCk7XG4gIH1cblxuICAvKlxuICAgKiBTRVRVUFNcbiAgICovXG4gIHNldHVwSW50cm8oKSB7XG4gICAgJChcIiNmaWxlUGlja2VySW5wdXRcIikub24oXCJjaGFuZ2VcIiwgKGV2ZW50KSA9PiB0aGlzLm9uRmlsZVNlbGVjdGVkKGV2ZW50KSk7XG4gICAgJChcIiNmaWxlUGlja2VyQnV0dG9uXCIpLm9uKFwiY2xpY2tcIiwgKCkgPT4gJChcIiNmaWxlUGlja2VySW5wdXRcIikudHJpZ2dlcihcImNsaWNrXCIpKTtcbiAgfVxuICBzZXR1cE1hcENob2ljZSgpIHtcbiAgICAkKFwiI2NhdGVnb3J5U2VsZWN0XCIpLm9uKFwiY2hhbmdlXCIsICgpID0+IHRoaXMuZ2VuTWFwU2VsZWN0KCkpO1xuICAgICQoXCIjbWFwTG9hZEJ1dHRvblwiKS5vbihcImNsaWNrXCIsICgpID0+IHRoaXMub25NYXBMb2FkQ2xpY2soKSk7XG4gICAgJChcIiNzY2FuTWFwTGlua1wiKS5vbihcImNsaWNrXCIsICgpID0+IHRoaXMub25TY2FuTWFwQ2xpY2soKSk7XG4gIH1cbiAgc2V0dXBNYXBFeHBsb3JlcigpIHtcbiAgICAkKFwiI3N3aXRjaENvbnRyb2xsZXJUeXBlXCIpLm9uKFwiY2xpY2tcIiwgKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuYXBwUmVuZGVyZXIuY29udHJvbGxlclR5cGUgPT09IFwiZmx5XCIpIHtcbiAgICAgICAgdGhpcy5hcHBSZW5kZXJlci5zZXR1cENvbnRyb2xsZXIoXCJvcmJpdGFsXCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5hcHBSZW5kZXJlci5zZXR1cENvbnRyb2xsZXIoXCJmbHlcIik7XG4gICAgICB9XG4gICAgfSk7XG4gICAgJChcIiNnb1RvTWFwU2VsZWN0QnV0dG9uXCIpLm9uKFwiY2xpY2tcIiwgKCkgPT4gdGhpcy5vbkJhY2tUb01hcFNlbGVjdCgpKTtcbiAgICAkKFwiI3Rha2VTY3JlZW5zaG90XCIpLm9uKFwiY2xpY2tcIiwgKCkgPT4gdGhpcy5hcHBSZW5kZXJlci50YWtlU2NyZWVuU2hvdCgpKTtcbiAgICAkKFwiI212bnRTcGVlZFJhbmdlXCIpLm9uKFwiY2hhbmdlXCIsIChldmVudCkgPT4gdGhpcy5hcHBSZW5kZXJlci5zZXRNb3ZlbWVudFNwZWVkKGV2ZW50LnRhcmdldC52YWx1ZUFzTnVtYmVyKSk7XG4gICAgJChcIiNmb2dSYW5nZVwiKS5vbihcImNoYW5nZVwiLCAoZXZlbnQpID0+IHRoaXMuYXBwUmVuZGVyZXIuc2V0Rm9nRGlzdGFuY2UoZXZlbnQudGFyZ2V0LnZhbHVlQXNOdW1iZXIpKTtcblxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwicmVzaXplXCIsICgpID0+IHRoaXMuYXBwUmVuZGVyZXIub25XaW5kb3dSZXNpemUoKSk7XG4gIH1cblxuICAvKlxuICAgKiBIQU5ETEVSU1xuICAgKi9cbiAgb25GaWxlU2VsZWN0ZWQoZXZlbnQpIHtcbiAgICBjb25zdCBmaWxlID0gZXZlbnQudGFyZ2V0LmZpbGVzWzBdO1xuICAgICQoXCIjaW50cm9cIikuc2xpZGVVcCgoKSA9PiB7XG4gICAgICB0aGlzLmFwcFJlbmRlcmVyLmNyZWF0ZUxvY2FsUmVhZGVyKGZpbGUsIGFzeW5jICgpID0+IHtcbiAgICAgICAgdGhpcy5hcmNoaXZlTG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5tYXBGaWxlTGlzdCA9IGF3YWl0IHRoaXMuYXBwUmVuZGVyZXIuZ2V0TWFwTGlzdCgpO1xuICAgICAgICB0aGlzLmZpbGxNYXBDaG9pY2VTZWxlY3QoKTtcbiAgICAgICAgLy8gVXNlciBtaWdodCBlbnRlciBhbiBub24tZXhpc3RhbnQgSUQgc28gd2Ugb25seSB0cmlnZ2VyIGF1dG9sb2FkIGlmIHdlIGZpbmQgdGhlIG1hcFxuICAgICAgICBpZiAodGhpcy5hdXRvTG9hZCAmJiB0aGlzLm1hcEZpbGVMaXN0LmZpbmQoKGkpID0+IGkuYmFzZUlkID09PSB0aGlzLmF1dG9Mb2FkLm1hcCkpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5vbkF1dG9Mb2FkKCk7XG4gICAgICAgIH1cbiAgICAgICAgJChcIiNjaG9vc2UtbWFwXCIpLmZhZGVJbigpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBvbkF1dG9Mb2FkKCkge1xuICAgIGNvbnN0IG1hcElkID0gdGhpcy5hdXRvTG9hZC5tYXA7XG4gICAgY29uc3QgcmVuZGVyT3B0aW9ucyA9IHtcbiAgICAgIHpvbmU6IHRoaXMuYXV0b0xvYWQubG9hZFpvbmUgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogdGhpcy5hdXRvTG9hZC5sb2FkWm9uZSxcbiAgICAgIHByb3BzOiB0aGlzLmF1dG9Mb2FkLmxvYWRQcm9wID09PSB1bmRlZmluZWQgPyB0cnVlIDogdGhpcy5hdXRvTG9hZC5sb2FkUHJvcCxcbiAgICAgIGNvbGxpc2lvbnM6IHRoaXMuYXV0b0xvYWQuc2hvd0hhdm9rID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IHRoaXMuYXV0b0xvYWQuc2hvd0hhdm9rLFxuICAgIH07XG4gICAgdGhpcy5zaG93aW5nUHJvZ3Jlc3MgPSB0cnVlO1xuICAgICQoXCIjbG9hZGluZy11aVwiKS5mYWRlSW4oKTtcbiAgICB0aGlzLmFwcFJlbmRlcmVyLmxvYWRNYXAobWFwSWQsIHJlbmRlck9wdGlvbnMsICgpID0+IHtcbiAgICAgIHRoaXMuYXBwUmVuZGVyZXIuc2V0dXBDb250cm9sbGVyKHRoaXMuYXV0b0xvYWQuY2FtZXJhVHlwZSB8fCBcImZseVwiKTtcbiAgICAgIHRoaXMuYXBwUmVuZGVyZXIubW92ZSh0aGlzLmF1dG9Mb2FkLngsIHRoaXMuYXV0b0xvYWQueSwgdGhpcy5hdXRvTG9hZC56KTtcbiAgICAgIHRoaXMuYXBwUmVuZGVyZXIucm90YXRlKHRoaXMuYXV0b0xvYWQucngsIHRoaXMuYXV0b0xvYWQucnksIHRoaXMuYXV0b0xvYWQucnopO1xuICAgICAgLy8gRG9uJ3QgZm9yZ2V0IHRvIGNsZWFudXAgYXV0b0xvYWQsIGlmIG5vdCBpdCBtaWdodCBicmVhayBtYXAgY2hvaWNlIFVJXG4gICAgICB0aGlzLmF1dG9Mb2FkID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5vbk1hcExvYWRlZCgpO1xuICAgIH0pO1xuICB9XG5cbiAgb25NYXBMb2FkQ2xpY2soKSB7XG4gICAgLy8gQW50aSBhbGlhc2luZyBvcHRpb24gY2FuIG9ubHkgYmUgZW5hYmxlZCB3aGVuIGNyZWF0aW5nIHRoZSB3ZWJnbCBjb250ZXh0XG4gICAgLy8gU28gd2UgdXBkYXRlIHRoYXQgZmlyc3QgaWYgbmVlZGVkXG4gICAgY29uc3QgYWFFbmFibGVkID0gJChcIiNlbmFibGVBQVwiKS5pcyhcIjpjaGVja2VkXCIpO1xuICAgIGlmICh0aGlzLmFwcFJlbmRlcmVyLndlYkdMUmVuZGVyZXJPcHRpb25zLmFudGlhbGlhc2luZyAhPT0gYWFFbmFibGVkKSB7XG4gICAgICB0aGlzLmFwcFJlbmRlcmVyLndlYkdMUmVuZGVyZXJPcHRpb25zLmFudGlhbGlhc2luZyA9IGFhRW5hYmxlZDtcbiAgICAgIHRoaXMuYXBwUmVuZGVyZXIuc2V0dXBXZWJHTFJlbmRlcmVyKHRydWUpO1xuICAgIH1cblxuICAgIGNvbnN0IG1hcElkID0gJChcIiNtYXBTZWxlY3RcIikudmFsKCk7XG4gICAgY29uc3QgcmVuZGVyT3B0aW9ucyA9IHtcbiAgICAgIHpvbmU6ICQoXCIjbG9hZFpvbmVcIikuaXMoXCI6Y2hlY2tlZFwiKSxcbiAgICAgIHByb3BzOiAkKFwiI2xvYWRQcm9wc1wiKS5pcyhcIjpjaGVja2VkXCIpLFxuICAgICAgY29sbGlzaW9uczogJChcIiNsb2FkQ29sbFwiKS5pcyhcIjpjaGVja2VkXCIpLFxuICAgIH07XG4gICAgJChcIiNjaG9vc2UtbWFwXCIpLnNsaWRlVXAoKCkgPT4ge1xuICAgICAgdGhpcy5zaG93aW5nUHJvZ3Jlc3MgPSB0cnVlO1xuICAgICAgJChcIiNsb2FkaW5nLXVpXCIpLmZhZGVJbigpO1xuICAgIH0pO1xuICAgIHRoaXMuYXBwUmVuZGVyZXIubG9hZE1hcChtYXBJZCwgcmVuZGVyT3B0aW9ucywgKCkgPT4ge1xuICAgICAgLy8gUmVzZXQgdGhlIHBvc2l0aW9uIG9mIHRoZSBjYW1lcmEgaWYgd2UgYWxyZWFkeSBsb2FkZWQgYSBwcmV2aW91cyBtYXBcbiAgICAgIHRoaXMuYXBwUmVuZGVyZXIuc2V0dXBDb250cm9sbGVyKCk7XG4gICAgICB0aGlzLm9uTWFwTG9hZGVkKCk7XG4gICAgfSk7XG4gIH1cblxuICBvbk1hcExvYWRlZCgpIHtcbiAgICB0aGlzLnNob3dpbmdQcm9ncmVzcyA9IGZhbHNlO1xuICAgICQoXCIjbG9hZGluZy11aVwiKS5zbGlkZVVwKCgpID0+IHtcbiAgICAgICQoXCJjYW52YXNcIikuZmFkZUluKCk7XG4gICAgICAkKFwiI2NvbnRyb2xzXCIpLmZhZGVJbigpO1xuICAgICAgJChcIiNsb2FkaW5nTmFtZVwiKS50ZXh0KFwiTG9hZGluZy4uLlwiKTtcbiAgICAgICQoXCIjbG9hZGluZ1ZhbHVlXCIpLnRleHQoXCJcIik7XG4gICAgfSk7XG4gICAgLy8gU3luYyB0aGUgaW5wdXQgcmFuZ2VzIHdpdGggdGhlaXIgdmFsdWUgaW4gdGhlIGFwcFJlbmRlcmVyXG4gICAgJChcIiNmb2dSYW5nZVwiKS52YWwodGhpcy5hcHBSZW5kZXJlci5mb2cpO1xuICAgICQoXCIjbXZudFNwZWVkUmFuZ2VcIikudmFsKHRoaXMuYXBwUmVuZGVyZXIubW92ZW1lbnRTcGVlZCk7XG4gICAgdGhpcy5zaG91bGRVcGRhdGVVcmwgPSB0cnVlO1xuICB9XG5cbiAgb25CYWNrVG9NYXBTZWxlY3QoKSB7XG4gICAgJChcIiNjb250cm9sc1wiKS5zbGlkZVVwKCgpID0+IHtcbiAgICAgICQoXCJjYW52YXNcIikuaGlkZSgwKTtcbiAgICAgICQoXCIjY2hvb3NlLW1hcFwiKS5mYWRlSW4oKTtcbiAgICAgIHRoaXMuYXBwUmVuZGVyZXIuY2xlYW51cE1hcCgpO1xuICAgICAgdGhpcy51cGRhdGVVcmwodHJ1ZSk7XG4gICAgICB0aGlzLnNob3VsZFVwZGF0ZVVybCA9IGZhbHNlO1xuICAgIH0pO1xuICB9XG5cbiAgb25GaWxlU2NhbkRvbmUoKSB7XG4gICAgdGhpcy5zaG93aW5nUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICAkKFwiI2xvYWRpbmctdWlcIikuc2xpZGVVcCgoKSA9PiB7XG4gICAgICAkKFwiI2Nob29zZS1tYXBcIikuZmFkZUluKCk7XG4gICAgICAkKFwiI2xvYWRpbmdOYW1lXCIpLnRleHQoXCJMb2FkaW5nLi4uXCIpO1xuICAgICAgJChcIiNsb2FkaW5nVmFsdWVcIikudGV4dChcIlwiKTtcbiAgICB9KTtcbiAgfVxuXG4gIG9uU2Nhbk1hcENsaWNrKCkge1xuICAgICQoXCIjY2hvb3NlLW1hcFwiKS5zbGlkZVVwKCgpID0+IHtcbiAgICAgICQoXCIjbG9hZGluZ05hbWVcIikudGV4dChcIlNjYW5uaW5nLi4uXCIpO1xuICAgICAgdGhpcy5zaG93aW5nUHJvZ3Jlc3MgPSB0cnVlO1xuICAgICAgJChcIiNsb2FkaW5nLXVpXCIpLmZhZGVJbihhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuYXBwUmVuZGVyZXIuc2NhbkFyY2hpdmVGb3JNYXBzKCk7XG4gICAgICAgIHRoaXMubWFwRmlsZUxpc3QgPSBhd2FpdCB0aGlzLmFwcFJlbmRlcmVyLmdldE1hcExpc3QoKTtcbiAgICAgICAgdGhpcy5maWxsTWFwQ2hvaWNlU2VsZWN0KCk7XG4gICAgICAgIHRoaXMub25GaWxlU2NhbkRvbmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgb25Nb3VzZVdoZWVsKGV2ZW50KSB7XG4gICAgY29uc3QgbmV3U3BlZWQgPVxuICAgICAgZXZlbnQub3JpZ2luYWxFdmVudC5kZWx0YVkgPCAwXG4gICAgICAgID8gTWF0aC5taW4odGhpcy5hcHBSZW5kZXJlci5tb3ZlbWVudFNwZWVkICsgMTAwLCAxMDAwMClcbiAgICAgICAgOiBNYXRoLm1heCh0aGlzLmFwcFJlbmRlcmVyLm1vdmVtZW50U3BlZWQgLSAxMDAsIDUwMCk7XG5cbiAgICB0aGlzLmFwcFJlbmRlcmVyLnNldE1vdmVtZW50U3BlZWQobmV3U3BlZWQpO1xuICAgICQoXCIjbXZudFNwZWVkUmFuZ2VcIikudmFsKG5ld1NwZWVkKTtcbiAgfVxuXG4gIC8qIFVUSUxTICovXG5cbiAgLyoqXG4gICAqIFRoaXMgZnVuY3Rpb24gZ2VuZXJhdGVzIHRoZSBjb250ZW50IG9mIHRoZSBtYXAgc2VsZWN0b3JcbiAgICogYW5kIE5PVCB0aGUgY2F0ZWdvcnkgb25lXG4gICAqL1xuICBnZW5NYXBTZWxlY3QoKSB7XG4gICAgY29uc3QgY2F0ZWdvcnkgPSAkKFwiI2NhdGVnb3J5U2VsZWN0XCIpLnZhbCgpO1xuICAgICQoXCIjbWFwU2VsZWN0XCIpLmVtcHR5KCk7XG4gICAgZm9yIChjb25zdCBtYXAgb2YgdGhpcy5tYXBGaWxlTGlzdCkge1xuICAgICAgaWYgKG1hcC5jYXRlZ29yeSA9PT0gY2F0ZWdvcnkpIHtcbiAgICAgICAgY29uc3Qgb3B0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcIm9wdGlvblwiKTtcbiAgICAgICAgb3B0LnZhbHVlID0gbWFwLmJhc2VJZDtcbiAgICAgICAgb3B0LmlubmVySFRNTCA9IG1hcC5uYW1lO1xuICAgICAgICAkKFwiI21hcFNlbGVjdFwiKS5hcHBlbmQob3B0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBmdW5jdGlvbiBnZW5lcmF0ZXMgdGhlIGNvbnRlbnQgb2YgdGhlIGNhdGVnb3J5IHNlbGVjdG9yXG4gICAqIGFuZCBOT1QgdGhlIG1hcCBvbmVcbiAgICovXG4gIGZpbGxNYXBDaG9pY2VTZWxlY3QoKSB7XG4gICAgY29uc3QgY2F0ZWdvcnlMaXN0ID0gdGhpcy5tYXBGaWxlTGlzdC5yZWR1Y2UoKGNhdGVnb3JpZXMsIG1hcCkgPT4ge1xuICAgICAgaWYgKGNhdGVnb3JpZXMuaW5kZXhPZihtYXAuY2F0ZWdvcnkpID09PSAtMSkge1xuICAgICAgICBjYXRlZ29yaWVzLnB1c2gobWFwLmNhdGVnb3J5KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBjYXRlZ29yaWVzO1xuICAgIH0sIFtdKTtcbiAgICBmb3IgKGNvbnN0IGNhdGVnb3J5IG9mIGNhdGVnb3J5TGlzdCkge1xuICAgICAgY29uc3Qgb3B0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcIm9wdGlvblwiKTtcbiAgICAgIG9wdC52YWx1ZSA9IGNhdGVnb3J5O1xuICAgICAgb3B0LmlubmVySFRNTCA9IGNhdGVnb3J5O1xuICAgICAgJChcIiNjYXRlZ29yeVNlbGVjdFwiKS5hcHBlbmQob3B0KTtcbiAgICB9XG4gICAgdGhpcy5nZW5NYXBTZWxlY3QoKTtcbiAgfVxuXG4gIHVwZGF0ZVVybChzaG91bGRDbGVhciA9IGZhbHNlKSB7XG4gICAgaWYgKHRoaXMuc2hvdWxkVXBkYXRlVXJsKSB7XG4gICAgICBpZiAoc2hvdWxkQ2xlYXIpIHtcbiAgICAgICAgd2luZG93LmxvY2F0aW9uLmhhc2ggPSBcIlwiO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgdXJsRGF0YSA9ICQucGFyYW0odGhpcy5hcHBSZW5kZXJlci5nZXRVcmxEYXRhKCkpO1xuICAgICAgICBpZiAodGhpcy5sYXN0VXJsRGF0YSAhPT0gdXJsRGF0YSkge1xuICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gdXJsRGF0YTtcbiAgICAgICAgICB0aGlzLmxhc3RVcmxEYXRhID0gdXJsRGF0YTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNoZWNrQXV0b0xvYWQoKSB7XG4gICAgY29uc3QgdXJsRGF0YSA9IGdldFBhcnNlZFVybCgpO1xuICAgIGlmICh1cmxEYXRhLm1hcCkge1xuICAgICAgdGhpcy5hdXRvTG9hZCA9IHVybERhdGE7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldFBhcnNlZFVybCgpIHtcbiAgY29uc3QgZGF0YSA9IGRlcGFyYW0od2luZG93LmxvY2F0aW9uLmhhc2guc2xpY2UoMSkpO1xuICBkYXRhLm1hcCA9IGRhdGEubWFwID8gcGFyc2VJbnQoZGF0YS5tYXApIDogdW5kZWZpbmVkO1xuICBkYXRhLnggPSBkYXRhLnggPyBwYXJzZUludChkYXRhLngpIDogdW5kZWZpbmVkO1xuICBkYXRhLnkgPSBkYXRhLnkgPyBwYXJzZUludChkYXRhLnkpIDogdW5kZWZpbmVkO1xuICBkYXRhLnogPSBkYXRhLnogPyBwYXJzZUludChkYXRhLnopIDogdW5kZWZpbmVkO1xuICBkYXRhLnJ4ID0gZGF0YS5yeCA/IHBhcnNlRmxvYXQoZGF0YS5yeCkgOiB1bmRlZmluZWQ7XG4gIGRhdGEucnkgPSBkYXRhLnJ5ID8gcGFyc2VGbG9hdChkYXRhLnJ5KSA6IHVuZGVmaW5lZDtcbiAgZGF0YS5yeiA9IGRhdGEucnogPyBwYXJzZUZsb2F0KGRhdGEucnopIDogdW5kZWZpbmVkO1xuICBkYXRhLmxvYWRab25lID0gZGF0YS5sb2FkWm9uZSA/IGRhdGEubG9hZFpvbmUgPT09IFwidHJ1ZVwiIDogdW5kZWZpbmVkO1xuICBkYXRhLmxvYWRQcm9wID0gZGF0YS5sb2FkUHJvcCA/IGRhdGEubG9hZFByb3AgPT09IFwidHJ1ZVwiIDogdW5kZWZpbmVkO1xuICBkYXRhLnNob3dIYXZvayA9IGRhdGEuc2hvd0hhdm9rID8gZGF0YS5zaG93SGF2b2sgPT09IFwidHJ1ZVwiIDogdW5kZWZpbmVkO1xuICBkYXRhLmZvZyA9IGRhdGEuZm9nID8gcGFyc2VJbnQoZGF0YS5mb2cpIDogdW5kZWZpbmVkO1xuXG4gIC8vIEJhY2t3YXJkIGNvbXBhdGliaWxpdHkgd2l0aCBUeXJpYTNEQXBwXG4gIGlmIChkYXRhLnBpdGNoICYmIGRhdGEueWF3KSB7XG4gICAgY29uc3QgcGl0Y2ggPSBwYXJzZUZsb2F0KGRhdGEucGl0Y2gpO1xuICAgIGNvbnN0IHlhdyA9IHBhcnNlRmxvYXQoZGF0YS55YXcpO1xuICAgIC8vIGNvbnZlcnQgcGl0Y2ggeWF3IHRvIHh5eiByb3RhdGlvbnM6XG4gICAgZGF0YS5yeCA9IC1NYXRoLmNvcyh5YXcpICogTWF0aC5jb3MocGl0Y2gpO1xuICAgIGRhdGEucnkgPSBNYXRoLnNpbih5YXcpICogTWF0aC5jb3MocGl0Y2gpO1xuICAgIGRhdGEucnogPSAtTWF0aC5zaW4ocGl0Y2gpO1xuICB9XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIGRlcGFyYW0ocXVlcnlTdHJpbmcpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBwYXJhbWV0ZXJzID0ge307XG4gICAgY29uc3QgY2h1bmtzID0gcXVlcnlTdHJpbmcuc3BsaXQoXCImXCIpO1xuICAgIGZvciAoY29uc3QgY2h1bmsgb2YgY2h1bmtzKSB7XG4gICAgICBjb25zdCBba2V5LCB2YWx1ZV0gPSBjaHVuay5zcGxpdChcIj1cIik7XG4gICAgICBwYXJhbWV0ZXJzW2RlY29kZVVSSUNvbXBvbmVudChrZXkpXSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7XG4gICAgfVxuICAgIHJldHVybiBwYXJhbWV0ZXJzO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIHJldHVybiB7fTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFVJO1xuIl19"}